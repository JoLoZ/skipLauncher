<link href="main.css" rel="stylesheet" />
<div class="background"></div>
<div class="wrapper" id="page-init">
  <div class="flex-center">
    <center>
      <div style="height: 5rem"></div>
      <h1>skipLauncher</h1>
      <div id="launch-info">
        <span>
          Hey
          <a id="launch-playername" href="javascript:page('account')">you</a>,
          ready to play Minecraft
          <a id="launch-version" href="javascript:select_version();">1.8.9</a>
          ?
        </span>
      </div>
      <button id="launch-btn" style="min-width: 10rem" onclick="btnaction()">
        Login with Microsoft
      </button>
      <div
        id="progress-container"
        style="min-height: 5rem; display: flex; align-items: flex-end"
      >
        <div style="width: 20rem">
          <pre id="status"></pre>
          <div class="progress-bar" style="display: none">
            <div class="inner" id="progress"></div>
          </div>
        </div>
      </div>
    </center>
  </div>
</div>
<div class="wrapper" id="page-version">
  <div class="flex-center">
    <center>
      <h3>Select Version</h3>
      <p>
        As a temporary solution, please put in the version identifier in the
        field below.
      </p>
      <input id="temp-version" value="1.8.9" />
      <button onclick="acceptVersion()">Set version</button>
    </center>
  </div>
</div>

<div class="wrapper" id="page-account">
  <div class="flex-center">
    <center>
      <h1>Manage your account</h1>
      <button onclick="login()">Switch or add accounts</button>
      <button onclick="logout()">Log out of all accounts</button>
      <br /><br />
      <button onclick="page('init')">Back</button>
    </center>
  </div>
</div>

<script src="topbar.js"></script>

<script>
  var config = require("./config");

  var auth = null;
  var selected_version = "1.8.9";

  page("init");

  function btnaction() {
    if (auth == null) {
      login();
    } else {
      launch(selected_version);
    }
  }

  function login(type) {
    ipcRenderer.send("login_new", {
      visible: type ?? "select_account",
    });
  }

  ipcRenderer.on("login_update", (event, arg) => {
    page("init");
    $("#progress")
      .width(arg.percent + "%")
      .parent()
      .clearQueue()
      .slideDown();
    $("#status").text(arg.data);
    $("#launch-btn").addClass("loading").prop("disabled", true).text("Loading");
    $("#launch-info").slideUp();
  });

  ipcRenderer.on("login_result", (event, arg) => {
    auth = arg;

    selected_version = config.get("version_number", "1.8.9");
    $("#launch-version").text(selected_version);
    $("#launch-playername").text(config.get("profile").name);

    $("#launch-btn")
      .removeClass("loading")
      .prop("disabled", false)
      .text("Play!");
    $("#status").text("");
    $("#progress").width("0%").parent().clearQueue().slideUp();

    $("#launch-info").clearQueue().slideDown();

    autoLaunchHandler();
  });

  function launch(version) {
    config.set("version_number", version ?? "1.8.9");

    $("#launch-version").text(version);
    ipcRenderer.send("launch", {
      auth: auth,
      version: {
        number: version,
        type: config.get("version_type", "release"),
      },
    });
    $("#launch-btn")
      .addClass("loading")
      .prop("disabled", true)
      .text("Launching");
  }

  ipcRenderer.on("launch_msg", (event, arg) => {
    $("#status").text(arg.replaceAll("[MCLC]: ", ""));
    console.log(arg);

    if (
      arg.toLowerCase().includes("downloaded") ||
      arg.toLowerCase().includes("collected")
    ) {
      $("#progress").parent().clearQueue().slideUp();
    }
  });

  ipcRenderer.on("launch_progress", (event, arg) => {
    $("#status").text("Downloading " + arg.type);
    $("#progress")
      .width((100 * arg.task) / arg.total + "%")
      .parent()
      .clearQueue()
      .slideDown();
  });

  function autoLaunchHandler() {
    console.log("auto launch handling in progress");
    var args = ipcRenderer.sendSync("get_args");
    console.log("Args:", args);

    if (args[1] == undefined) {
      console.info("Skipping auto launch");
      return;
    } else {
      args[1] = args[1].toLowerCase();
    }

    if (args[1].includes("skiplauncher://launch/")) {
      console.info("Proceeding to auto launch");
      launch(args[1].replace("skiplauncher://launch/", ""));
    } else {
      console.warn("No auto launch action fitting");
    }
  }

  function select_version() {
    $("#temp-version").val(selected_version);
    page("version");
  }

  var currentPage = "init";
  function page(id) {
    if (currentPage == id) {
      return;
    }
    $(".wrapper").clearQueue().fadeOut();
    $("#page-" + id)
      .delay(450)
      .fadeIn();
    currentPage = id;
  }

  function acceptVersion() {
    selected_version = $("#temp-version").val();
    $("#launch-version").text(selected_version);
    config.set("version_number", selected_version ?? "1.8.9");
    page("init");
  }

  function logout() {
    page("none");
    setTimeout(() => {
      ipcRenderer.send("logout");
    }, 450);
  }
</script>
